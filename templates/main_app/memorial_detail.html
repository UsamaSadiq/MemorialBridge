{% extends 'base.html' %}
{% load static %}

{% block title %}{{ memorial.name }} - MemorialBridge{% endblock %}

{% block meta_description %}Memorial page for {{ memorial.name }}{% if memorial.dob and memorial.dod %}, {{ memorial.dob|date:"Y" }}-{{ memorial.dod|date:"Y" }}{% endif %}. {{ memorial.bio|truncatewords:30 }}{% endblock %}

{% block og_title %}{{ memorial.name }} - MemorialBridge{% endblock %}
{% block og_description %}{{ memorial.bio|truncatewords:30 }}{% endblock %}
{% block og_image %}{% if memorial.cover_image %}{{ memorial.cover_image.url }}{% else %}{% static 'img/cover.png' %}{% endif %}{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "{{ memorial.name }}",
    {% if memorial.dob %}"birthDate": "{{ memorial.dob|date:'Y-m-d' }}",{% endif %}
    {% if memorial.dod %}"deathDate": "{{ memorial.dod|date:'Y-m-d' }}",{% endif %}
    "description": "{{ memorial.bio|striptags }}",
    {% if memorial.cover_image %}"image": "{{ memorial.cover_image.url }}"{% endif %}
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    .memorial-detail-wrapper {
        background: linear-gradient(180deg, rgba(14, 104, 89, 0.05), rgba(255, 255, 255, 1) 30%, rgba(14, 104, 89, 0.03));
        min-height: 100vh;
    }
    
    .memorial-header-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(14, 104, 89, 0.02));
        border: 1px solid rgba(14, 104, 89, 0.1);
        transition: all 0.3s ease;
    }
    
    .memorial-profile-img,
    .memorial-profile-placeholder {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border: 4px solid rgba(14, 104, 89, 0.1);
    }
    
    .stat-box {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(14, 104, 89, 0.03));
        border: 1px solid rgba(14, 104, 89, 0.1);
        transition: all 0.3s ease;
    }
    
    .stat-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(14, 104, 89, 0.12) !important;
        border-color: var(--color-primary);
    }
    
    .section-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(14, 104, 89, 0.01));
        border: 1px solid rgba(14, 104, 89, 0.1);
        transition: all 0.3s ease;
    }
    
    .section-card:hover {
        box-shadow: 0 10px 30px rgba(14, 104, 89, 0.1) !important;
    }
    
    .add-memory-section {
        background: linear-gradient(135deg, rgba(14, 104, 89, 0.05), rgba(14, 104, 89, 0.02));
        border: 1px solid rgba(14, 104, 89, 0.1);
    }
    
    .memory-item {
        transition: all 0.2s ease;
        padding: 1.25rem;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.5);
    }
    
    .memory-item:hover {
        background: rgba(14, 104, 89, 0.02);
        box-shadow: 0 2px 8px rgba(14, 104, 89, 0.08);
    }
    
    .memory-item:last-child {
        border-bottom: none !important;
        margin-bottom: 0 !important;
    }
    
    .avatar-circle {
        width: 48px;
        height: 48px;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .sidebar-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(14, 104, 89, 0.02));
        border: 1px solid rgba(14, 104, 89, 0.1);
    }
    
    @media (min-width: 992px) {
        .sidebar-sticky {
            position: sticky;
            top: 80px;
            z-index: 10;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="memorial-detail-wrapper">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-xl-10 col-lg-11">
                <!-- Memorial Header -->
                <article class="mb-4" role="article" aria-label="Memorial for {{ memorial.name }}">
                    <div class="memorial-header-card rounded-lg shadow-sm p-4">
                        <div class="row align-items-center">
                            <div class="col-md-3 text-center text-md-start mb-3 mb-md-0">
                            {% if memorial.cover_image %}
                            <img src="{{ memorial.cover_image.url }}" 
                                 class="memorial-profile-img rounded-circle shadow-md" 
                                 alt="Portrait of {{ memorial.name }}{% if memorial.dob and memorial.dod %}, lived {{ memorial.dob|date:'Y' }}-{{ memorial.dod|date:'Y' }}{% endif %}"
                                 width="150"
                                 height="150"
                                 loading="eager">
                            {% else %}
                            <div class="memorial-profile-placeholder rounded-circle shadow-md d-inline-flex align-items-center justify-content-center"
                                 style="background: linear-gradient(135deg, rgba(14, 104, 89, 0.1), rgba(14, 104, 89, 0.05));"
                                 role="img"
                                 aria-label="No profile image available for {{ memorial.name }}">
                                <i class="fas fa-user fa-4x text-primary opacity-50" aria-hidden="true"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h1 class="memorial-name fw-bold mb-2 text-primary">{{ memorial.name }}</h1>
                                    {% if memorial.dob and memorial.dod %}
                                    <p class="memorial-dates text-muted h5 mb-0">
                                        <i class="fas fa-calendar-alt me-2" aria-hidden="true"></i>
                                        <time datetime="{{ memorial.dob|date:'Y-m-d' }}">{{ memorial.dob|date:"F j, Y" }}</time> - 
                                        <time datetime="{{ memorial.dod|date:'Y-m-d' }}">{{ memorial.dod|date:"F j, Y" }}</time>
                                    </p>
                                    {% endif %}
                                </div>
                                <button class="btn btn-primary copy-link-btn shadow-sm" 
                                        data-slug="{{ memorial.slug }}"
                                        aria-label="Share memorial link for {{ memorial.name }}"
                                        title="Share Memorial">
                                    <i class="fas fa-share" aria-hidden="true"></i>
                                </button>
                            </div>
                            
                            {% if can_edit %}
                            <div class="memorial-actions d-flex flex-wrap gap-2 mb-3">
                                <a href="{% url 'edit_memorial' memorial.slug %}" class="btn btn-outline-primary" aria-label="Edit memorial for {{ memorial.name }}">
                                    <i class="fas fa-edit me-2" aria-hidden="true"></i>Edit Memorial
                                </a>
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" aria-label="Delete memorial for {{ memorial.name }}">
                                    <i class="fas fa-trash me-2" aria-hidden="true"></i>Delete
                                </button>
                            </div>
                            {% endif %}
                            
                            <div class="memorial-stats" role="region" aria-label="Memorial statistics">
                                <div class="row g-3">
                                    <div class="col-6 col-md-3">
                                        <div class="stat-box text-center p-3 rounded-lg shadow-sm">
                                            <div class="stat-number text-success fw-bold h4 mb-0" aria-label="{{ memorial.donations_count }} donations">{{ memorial.donations_count }}</div>
                                            <div class="stat-label text-muted small">Donations</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-box text-center p-3 rounded-lg shadow-sm">
                                            <div class="stat-number text-primary fw-bold h4 mb-0" aria-label="{{ memorial.trees_planted_count }} trees planted">{{ memorial.trees_planted_count }}</div>
                                            <div class="stat-label text-muted small">Trees Planted</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-box text-center p-3 rounded-lg shadow-sm">
                                            <div class="stat-number text-info fw-bold h4 mb-0" aria-label="{{ memories.count }} memories shared">{{ memories.count }}</div>
                                            <div class="stat-label text-muted small">Memories</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-box text-center p-3 rounded-lg shadow-sm">
                                            <div class="stat-number text-warning fw-bold h4 mb-0" aria-label="Total impact: {{ memorial.total_contributions }}">{{ memorial.total_contributions }}</div>
                                            <div class="stat-label text-muted small">Total Impact</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>

                <div class="row">
                    <!-- Biography Section -->
                    <div class="col-lg-8">
                        {% if memorial.bio %}
                        <div class="section-card rounded-lg shadow-sm mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4 fw-bold text-primary">
                        <i class="fas fa-book me-2"></i>Biography
                    </h3>
                <div class="card-text lh-lg" style="font-size: 1.05rem; color: var(--color-gray-700);">{{ memorial.bio|linebreaks }}</div>
                </div>
            </div>
            {% endif %}

                    <!-- Memories Section -->
                    <div class="section-card rounded-lg shadow-sm mb-4">
                        <div class="card-body p-4">
                                    <h3 class="card-title mb-4 fw-bold text-primary">
                                <i class="fas fa-heart me-2"></i>Memories <span class="badge bg-primary text-white ms-2">{{ memories.count }}</span>
                            </h3>
                            
                            <!-- Add Memory Form -->
                            {% if user.is_authenticated %}
                                    <div class="add-memory-section mb-4 p-4 rounded-lg">
                                <h5 class="mb-3 fw-bold text-primary"><i class="fas fa-pen me-2"></i>Share a Memory</h5>
                                <form method="post" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input type="hidden" name="memory_submit" value="1">
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            {{ memory_form.type.label_tag }}
                                            {{ memory_form.type }}
                                        </div>
                                                <div class="col-md-9 mb-3">
                                            <div id="memory-content-field">
                                                {{ memory_form.content.label_tag }}
                                                {{ memory_form.content }}
                                            </div>
                                            <div id="memory-image-field" style="display: none;">
                                                {{ memory_form.image.label_tag }}
                                                {{ memory_form.image }}
                                            </div>
                                            <div id="memory-video-field" style="display: none;">
                                                {{ memory_form.video_url.label_tag }}
                                                {{ memory_form.video_url }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary shadow-sm">
                                        <i class="fas fa-plus me-2"></i>Add Memory
                                    </button>
                                </form>
                            </div>
                            {% else %}
                                    <div class="alert alert-info mb-4 border-0 shadow-sm">
                                <i class="fas fa-info-circle me-2"></i>
                                <a href="{% url 'login' %}" class="alert-link fw-bold">Log in</a> to share your memories of {{ memorial.name }}.
                            </div>
                            {% endif %}

                            <!-- Memories List -->
                            <div class="memories-list">
                                {% for memory in memories %}
                                <div class="memory-item border-0">
                                    <div class="d-flex align-items-start">
                                        <div class="memory-avatar me-3">
                                            <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm">
                                                {{ memory.author.username|first|upper }}
                                            </div>
                                        </div>
                                        <div class="memory-content flex-grow-1">
                                                    <div class="memory-header d-flex justify-content-between align-items-start mb-2">
                                                <div>
                                                    <strong class="text-primary">{{ memory.author.username }}</strong>
                                                    <span class="badge bg-primary bg-opacity-75 text-white ms-2">{{ memory.get_type_display }}</span>
                                                </div>
                                                <small class="text-muted">{{ memory.created_at|date:"M j, Y" }}</small>
                                            </div>
                                            
                                            {% if memory.type == 'text' %}
                                                <div class="memory-text" style="color: var(--color-gray-700);">{{ memory.content|linebreaks }}</div>
                                                    {% elif memory.type == 'image' %}
                                                {% if memory.image %}
                                                <img src="{{ memory.image.url }}" class="img-fluid rounded-lg shadow-sm mb-2" alt="Memory image" style="max-height: 400px; object-fit: cover;">
                                                {% endif %}
                                                {% if memory.content %}
                                                <div class="memory-text mt-2" style="color: var(--color-gray-700);">{{ memory.content|linebreaks }}</div>
                                                {% endif %}
                                            {% elif memory.type == 'video' %}
                                                {% if memory.video_url %}
                                                <div class="video-memory mb-2">
                                                    <a href="{{ memory.video_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-play me-2"></i>Watch Video
                                                    </a>
                                                </div>
                                                {% endif %}
                                                {% if memory.content %}
                                                <div class="memory-text" style="color: var(--color-gray-700);">{{ memory.content|linebreaks }}</div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center py-5">
                                    <div class="empty-state">
                                        <i class="fas fa-heart fa-3x text-primary mb-3 d-block opacity-25"></i>
                                        <p class="text-muted mb-0">No memories shared yet. Be the first to share a memory of {{ memorial.name }}.</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <div class="sidebar-sticky">
                        <!-- Contribution Section -->
                        <div class="sidebar-card rounded-lg shadow-sm mb-4">
                            <div class="card-body text-center p-4">
                                <h4 class="card-title mb-3 fw-bold text-primary">
                                    <i class="fas fa-hands-helping me-2"></i>Honor Their Memory
                                </h4>
                                <p class="text-muted mb-4">Make a meaningful contribution in memory of {{ memorial.name }}</p>
                                
                                <div class="d-grid gap-3">
                                    {% if user.is_authenticated %}
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" name="donate" class="btn btn-success btn-lg w-100 shadow-sm text-white">
                                            <i class="fas fa-heart me-2"></i>Donate
                                            <div class="small mt-1 opacity-75">Current: {{ memorial.donations_count }}</div>
                                        </button>
                                    </form>
                                    
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" name="plant_tree" class="btn btn-primary btn-lg w-100 shadow-sm">
                                            <i class="fas fa-tree me-2"></i>Plant a Tree
                                            <div class="small mt-1 opacity-75">Current: {{ memorial.trees_planted_count }}</div>
                                        </button>
                                    </form>
                                    {% else %}
                                    <div class="alert alert-info mb-0 border-0 shadow-sm">
                                        <a href="{% url 'login' %}" class="alert-link fw-bold">Log in</a> to make contributions.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Memorial Info -->
                        <div class="sidebar-card rounded-lg shadow-sm">
                            <div class="card-body p-4">
                                <h5 class="card-title text-primary mb-4 fw-bold"><i class="fas fa-info-circle me-2"></i>Memorial Details</h5>
                                
                                <div class="memorial-details">
                                    <div class="detail-item mb-3 pb-3 border-bottom">
                                        <div class="text-muted small mb-1">Created by</div>
                                        <div class="fw-semibold text-primary">{{ memorial.owner.user.username }}</div>
                                    </div>
                                    <div class="detail-item mb-3 pb-3 border-bottom">
                                        <div class="text-muted small mb-1">Created</div>
                                        <div class="fw-semibold">{{ memorial.created_at|date:"F j, Y" }}</div>
                                    </div>
                                    <div class="detail-item mb-3 pb-3 border-bottom">
                                        <div class="text-muted small mb-1">Visibility</div>
                                        <span class="badge bg-{% if memorial.visibility == 'public' %}success{% else %}secondary{% endif %} text-white">
                                            {{ memorial.get_visibility_display }}
                                        </span>
                                    </div>
                                    {% if memorial.dob %}
                                    <div class="detail-item mb-3 pb-3 border-bottom">
                                        <div class="text-muted small mb-1">Born</div>
                                        <div class="fw-semibold">{{ memorial.dob|date:"F j, Y" }}</div>
                                    </div>
                                    {% endif %}
                                    {% if memorial.dod %}
                                    <div class="detail-item mb-0">
                                        <div class="text-muted small mb-1">Passed</div>
                                        <div class="fw-semibold">{{ memorial.dod|date:"F j, Y" }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% if can_edit %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-danger shadow-lg" style="border-width: 3px;">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>⚠️ DELETE MEMORIAL - PERMANENT ACTION ⚠️
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="deleteModalBody">
                <h6 class="text-danger fw-bold mb-3 fs-5">
                    You are about to permanently delete the memorial for <span class="text-decoration-underline">{{ memorial.name }}</span>
                </h6>
                
                <div class="border border-danger rounded-lg p-3 mb-3 shadow-sm" style="background-color: #f8d7da;">
                    <h6 class="fw-bold mb-2 text-danger"><i class="fas fa-trash-alt me-2"></i>The following will be PERMANENTLY DELETED:</h6>
                    <ul class="mb-0 text-dark" id="deleteDetailsList">
                        <li><strong>{{ memories.count }}</strong> memories shared by friends and family</li>
                        <li><strong>{{ memorial.donations_count }}</strong> donation records</li>
                        <li><strong>{{ memorial.trees_planted_count }}</strong> tree planting records</li>
                        <li>Cover photo and all media files</li>
                        <li>Complete biography and life story</li>
                        <li>All statistics and memorial data</li>
                    </ul>
                </div>
                
                <div class="text-center p-3 rounded-lg mb-0 shadow-sm" style="background-color: #fff3cd; border: 2px solid #ffc107;">
                    <p class="mb-0 fw-bold fs-5 text-danger">
                        <i class="fas fa-question-circle me-2"></i>Are you absolutely certain you want to proceed?
                    </p>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light d-flex justify-content-between">
                <button type="button" class="btn btn-success btn-lg px-4 shadow-sm text-white" data-bs-dismiss="modal">
                    <i class="fas fa-shield-alt me-2"></i>No, Keep Memorial Safe
                </button>
                <form method="post" action="{% url 'delete_memorial' memorial.slug %}" class="d-inline" id="deleteMemorialForm">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-lg px-4 shadow-sm" id="confirmDeleteBtn">
                        <i class="fas fa-trash-alt me-2"></i>YES, DELETE FOREVER
                    </button>
                
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Preserve modal content - prevent any clearing
document.addEventListener('DOMContentLoaded', function() {
    const deleteModal = document.getElementById('deleteModal');
    const modalBody = document.getElementById('deleteModalBody');
    
    if (deleteModal && modalBody) {
        // Store the original content
        const originalContent = modalBody.innerHTML;
        
        // Restore content when modal is shown
        deleteModal.addEventListener('show.bs.modal', function() {
            if (modalBody.innerHTML.trim() === '') {
                modalBody.innerHTML = originalContent;
            }
        });
        
        // Prevent any form from clearing the modal content
        deleteModal.addEventListener('hide.bs.modal', function(e) {
            // Only allow closing via the buttons, not by other means
            if (!e.target.classList.contains('modal')) {
                return true;
            }
        });
    }
});
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Memory type switcher
    const typeSelect = document.getElementById('memory-type');
    const contentField = document.getElementById('memory-content-field');
    const imageField = document.getElementById('memory-image-field');
    const videoField = document.getElementById('memory-video-field');
    
    if (typeSelect) {
        typeSelect.addEventListener('change', function() {
            // Hide all fields first
            contentField.style.display = 'none';
            imageField.style.display = 'none';
            videoField.style.display = 'none';
            
            // Show appropriate field based on selection
            if (this.value === 'text') {
                contentField.style.display = 'block';
            } else if (this.value === 'image') {
                imageField.style.display = 'block';
                contentField.style.display = 'block'; // Optional caption
            } else if (this.value === 'video') {
                videoField.style.display = 'block';
                contentField.style.display = 'block'; // Optional description
            }
        });
        
        // Trigger change event on page load
        typeSelect.dispatchEvent(new Event('change'));
    }
    
    // Copy link functionality with toast notification
    const copyBtn = document.querySelector('.copy-link-btn');
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const slug = this.dataset.slug;
            const url = window.location.origin + '/m/' + slug + '/';
            
            navigator.clipboard.writeText(url).then(function() {
                // Show success toast
                showToast('Link copied to clipboard!', 'success');
            }).catch(function(err) {
                // Show error toast
                console.error('Failed to copy: ', err);
                showToast('Failed to copy link', 'error');
            });
        });
    }
    
    // Toast notification function
    function showToast(message, type = 'success') {
        // Remove existing toast if any
        const existingToast = document.querySelector('.copy-toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        // Create toast element
        const toast = document.createElement('div');
        toast.className = 'copy-toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#28a745' : '#dc3545'};
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease-out;
        `;
        
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        toast.innerHTML = `<i class="fas ${icon}"></i>${message}`;
        
        document.body.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(function() {
            toast.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(function() {
                toast.remove();
            }, 300);
        }, 3000);
    }
});
</script>

<style>
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
{% endblock %}
